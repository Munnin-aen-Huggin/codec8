# Plan 11-01: Database Schema for Teams

## Objective

Create the foundational database schema to support team-based features including team entities, memberships, invitations, and custom templates.

## Prerequisites

- Supabase database access
- Existing profiles and repositories tables
- Understanding of RLS policies

## Tasks

### 1. Create Migration File

**File:** `supabase/migrations/20260115_add_teams_schema.sql`

```sql
-- ============================================
-- PHASE 11: TEAM COLLABORATION SCHEMA
-- ============================================

-- 1. TEAMS TABLE
CREATE TABLE IF NOT EXISTS public.teams (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  owner_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  stripe_subscription_id TEXT,
  max_seats INTEGER DEFAULT 5,
  max_repos_per_month INTEGER DEFAULT 100,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. TEAM MEMBERS TABLE
CREATE TABLE IF NOT EXISTS public.team_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID NOT NULL REFERENCES public.teams(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('owner', 'admin', 'member')),
  joined_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(team_id, user_id)
);

-- 3. TEAM INVITATIONS TABLE
CREATE TABLE IF NOT EXISTS public.team_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID NOT NULL REFERENCES public.teams(id) ON DELETE CASCADE,
  email TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'member' CHECK (role IN ('admin', 'member')),
  invited_by UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  token TEXT UNIQUE NOT NULL,
  expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '7 days'),
  accepted_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(team_id, email)
);

-- 4. DOC TEMPLATES TABLE
CREATE TABLE IF NOT EXISTS public.doc_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  team_id UUID NOT NULL REFERENCES public.teams(id) ON DELETE CASCADE,
  doc_type TEXT NOT NULL CHECK (doc_type IN ('readme', 'api', 'architecture', 'setup')),
  name TEXT NOT NULL,
  prompt_template TEXT NOT NULL,
  is_default BOOLEAN DEFAULT false,
  created_by UUID NOT NULL REFERENCES public.profiles(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(team_id, name)
);

-- 5. USAGE ANALYTICS TABLE
CREATE TABLE IF NOT EXISTS public.usage_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
  team_id UUID REFERENCES public.teams(id) ON DELETE SET NULL,
  repo_id UUID REFERENCES public.repositories(id) ON DELETE SET NULL,
  doc_type TEXT NOT NULL,
  tokens_used INTEGER DEFAULT 0,
  generation_time_ms INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 6. MODIFY REPOSITORIES TABLE
ALTER TABLE public.repositories
ADD COLUMN IF NOT EXISTS team_id UUID REFERENCES public.teams(id) ON DELETE SET NULL;

-- 7. MODIFY PROFILES TABLE
ALTER TABLE public.profiles
ADD COLUMN IF NOT EXISTS default_team_id UUID REFERENCES public.teams(id) ON DELETE SET NULL;

-- 8. ADD TEAM USAGE TRACKING
ALTER TABLE public.teams
ADD COLUMN IF NOT EXISTS repos_used_this_month INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS repos_reset_at TIMESTAMPTZ DEFAULT NOW();
```

### 2. Create Indexes

```sql
-- Team lookups
CREATE INDEX IF NOT EXISTS idx_teams_owner_id ON public.teams(owner_id);
CREATE INDEX IF NOT EXISTS idx_teams_slug ON public.teams(slug);

-- Member lookups
CREATE INDEX IF NOT EXISTS idx_team_members_team_id ON public.team_members(team_id);
CREATE INDEX IF NOT EXISTS idx_team_members_user_id ON public.team_members(user_id);

-- Invitation lookups
CREATE INDEX IF NOT EXISTS idx_team_invitations_email ON public.team_invitations(email);
CREATE INDEX IF NOT EXISTS idx_team_invitations_token ON public.team_invitations(token);

-- Template lookups
CREATE INDEX IF NOT EXISTS idx_doc_templates_team_id ON public.doc_templates(team_id);

-- Usage analytics
CREATE INDEX IF NOT EXISTS idx_usage_logs_user_id ON public.usage_logs(user_id);
CREATE INDEX IF NOT EXISTS idx_usage_logs_team_id ON public.usage_logs(team_id);
CREATE INDEX IF NOT EXISTS idx_usage_logs_created_at ON public.usage_logs(created_at);

-- Team repos
CREATE INDEX IF NOT EXISTS idx_repositories_team_id ON public.repositories(team_id)
WHERE team_id IS NOT NULL;
```

### 3. Create RLS Policies

```sql
-- Enable RLS
ALTER TABLE public.teams ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.team_members ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.team_invitations ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.doc_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.usage_logs ENABLE ROW LEVEL SECURITY;

-- TEAMS POLICIES
CREATE POLICY "Users can view their teams"
ON public.teams FOR SELECT
USING (
  id IN (SELECT team_id FROM public.team_members WHERE user_id = auth.uid())
);

CREATE POLICY "Team owners can update their teams"
ON public.teams FOR UPDATE
USING (owner_id = auth.uid());

CREATE POLICY "Users can create teams"
ON public.teams FOR INSERT
WITH CHECK (owner_id = auth.uid());

CREATE POLICY "Team owners can delete their teams"
ON public.teams FOR DELETE
USING (owner_id = auth.uid());

-- TEAM MEMBERS POLICIES
CREATE POLICY "Team members can view team membership"
ON public.team_members FOR SELECT
USING (
  team_id IN (SELECT team_id FROM public.team_members WHERE user_id = auth.uid())
);

CREATE POLICY "Team admins can manage members"
ON public.team_members FOR ALL
USING (
  team_id IN (
    SELECT team_id FROM public.team_members
    WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  )
);

-- TEAM INVITATIONS POLICIES
CREATE POLICY "Team admins can view invitations"
ON public.team_invitations FOR SELECT
USING (
  team_id IN (
    SELECT team_id FROM public.team_members
    WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  )
);

CREATE POLICY "Team admins can create invitations"
ON public.team_invitations FOR INSERT
WITH CHECK (
  team_id IN (
    SELECT team_id FROM public.team_members
    WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  )
);

CREATE POLICY "Team admins can delete invitations"
ON public.team_invitations FOR DELETE
USING (
  team_id IN (
    SELECT team_id FROM public.team_members
    WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  )
);

-- DOC TEMPLATES POLICIES
CREATE POLICY "Team members can view templates"
ON public.doc_templates FOR SELECT
USING (
  team_id IN (SELECT team_id FROM public.team_members WHERE user_id = auth.uid())
);

CREATE POLICY "Team admins can manage templates"
ON public.doc_templates FOR ALL
USING (
  team_id IN (
    SELECT team_id FROM public.team_members
    WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
  )
);

-- USAGE LOGS POLICIES
CREATE POLICY "Users can view their usage logs"
ON public.usage_logs FOR SELECT
USING (
  user_id = auth.uid() OR
  team_id IN (SELECT team_id FROM public.team_members WHERE user_id = auth.uid())
);

CREATE POLICY "System can insert usage logs"
ON public.usage_logs FOR INSERT
WITH CHECK (true);
```

### 4. Create Helper Functions

```sql
-- Function to check if user is team member
CREATE OR REPLACE FUNCTION is_team_member(p_team_id UUID, p_user_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.team_members
    WHERE team_id = p_team_id AND user_id = p_user_id
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to check if user is team admin
CREATE OR REPLACE FUNCTION is_team_admin(p_team_id UUID, p_user_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM public.team_members
    WHERE team_id = p_team_id
    AND user_id = p_user_id
    AND role IN ('owner', 'admin')
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Function to get team usage
CREATE OR REPLACE FUNCTION get_team_usage(p_team_id UUID)
RETURNS TABLE (
  total_docs INTEGER,
  docs_by_type JSONB,
  repos_used INTEGER,
  seats_used INTEGER
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    (SELECT COUNT(*)::INTEGER FROM public.usage_logs WHERE team_id = p_team_id),
    (SELECT jsonb_object_agg(doc_type, count) FROM (
      SELECT doc_type, COUNT(*)::INTEGER as count
      FROM public.usage_logs
      WHERE team_id = p_team_id
      GROUP BY doc_type
    ) t),
    (SELECT repos_used_this_month FROM public.teams WHERE id = p_team_id),
    (SELECT COUNT(*)::INTEGER FROM public.team_members WHERE team_id = p_team_id);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to create team owner membership
CREATE OR REPLACE FUNCTION create_team_owner_membership()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.team_members (team_id, user_id, role)
  VALUES (NEW.id, NEW.owner_id, 'owner');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_team_created
  AFTER INSERT ON public.teams
  FOR EACH ROW
  EXECUTE FUNCTION create_team_owner_membership();
```

### 5. Update TypeScript Types

**File:** `src/lib/types.ts` (additions)

```typescript
export interface Team {
  id: string;
  name: string;
  slug: string;
  owner_id: string;
  stripe_subscription_id: string | null;
  max_seats: number;
  max_repos_per_month: number;
  repos_used_this_month: number;
  repos_reset_at: string | null;
  created_at: string;
  updated_at: string;
}

export interface TeamMember {
  id: string;
  team_id: string;
  user_id: string;
  role: 'owner' | 'admin' | 'member';
  joined_at: string;
  // Joined data
  profile?: Profile;
}

export interface TeamInvitation {
  id: string;
  team_id: string;
  email: string;
  role: 'admin' | 'member';
  invited_by: string;
  token: string;
  expires_at: string;
  accepted_at: string | null;
  created_at: string;
}

export interface DocTemplate {
  id: string;
  team_id: string;
  doc_type: 'readme' | 'api' | 'architecture' | 'setup';
  name: string;
  prompt_template: string;
  is_default: boolean;
  created_by: string;
  created_at: string;
  updated_at: string;
}

export interface UsageLog {
  id: string;
  user_id: string | null;
  team_id: string | null;
  repo_id: string | null;
  doc_type: string;
  tokens_used: number;
  generation_time_ms: number;
  created_at: string;
}

export interface TeamUsage {
  total_docs: number;
  docs_by_type: Record<string, number>;
  repos_used: number;
  seats_used: number;
}
```

## Verification

- [ ] Migration runs without errors
- [ ] All tables created with correct columns
- [ ] Indexes created for performance
- [ ] RLS policies working correctly
- [ ] Helper functions return expected results
- [ ] TypeScript types match database schema
- [ ] Team creation trigger works

## Rollback

```sql
-- Rollback script (if needed)
DROP TABLE IF EXISTS public.usage_logs CASCADE;
DROP TABLE IF EXISTS public.doc_templates CASCADE;
DROP TABLE IF EXISTS public.team_invitations CASCADE;
DROP TABLE IF EXISTS public.team_members CASCADE;
DROP TABLE IF EXISTS public.teams CASCADE;
ALTER TABLE public.repositories DROP COLUMN IF EXISTS team_id;
ALTER TABLE public.profiles DROP COLUMN IF EXISTS default_team_id;
DROP FUNCTION IF EXISTS is_team_member;
DROP FUNCTION IF EXISTS is_team_admin;
DROP FUNCTION IF EXISTS get_team_usage;
DROP FUNCTION IF EXISTS create_team_owner_membership;
```

## Notes

- Team owner is automatically added as member via trigger
- Usage logs are kept even if user/team is deleted (SET NULL)
- Invitations expire after 7 days by default
- RLS ensures users can only see their own teams
