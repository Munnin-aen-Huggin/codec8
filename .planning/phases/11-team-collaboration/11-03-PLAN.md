# Plan 11-03: Usage Analytics Dashboard

## Objective

Create a comprehensive analytics dashboard for Pro and Team tier users showing documentation generation statistics, usage trends, and quota tracking.

## Prerequisites

- Plan 11-01 (Database Schema) completed
- `usage_logs` table created
- Existing doc generation endpoint

## Tasks

### 1. Update Doc Generation to Log Usage

**File:** `src/routes/api/docs/generate/+server.ts` (modification)

Add usage logging after successful generation:

```typescript
// Add import
import { logUsage } from '$lib/server/usage';

// After successful doc generation, add:
await logUsage({
  userId: user.id,
  teamId: profile?.default_team_id || null,
  repoId: repo.id,
  docType: type,
  tokensUsed: response.usage?.total_tokens || 0,
  generationTimeMs: Date.now() - startTime
});
```

### 2. Create Usage Server Functions

**File:** `src/lib/server/usage.ts` (additions)

```typescript
import { supabaseAdmin } from './supabase';
import type { UsageLog } from '$lib/types';

interface LogUsageParams {
  userId: string;
  teamId: string | null;
  repoId: string;
  docType: string;
  tokensUsed: number;
  generationTimeMs: number;
}

export async function logUsage(params: LogUsageParams): Promise<void> {
  await supabaseAdmin.from('usage_logs').insert({
    user_id: params.userId,
    team_id: params.teamId,
    repo_id: params.repoId,
    doc_type: params.docType,
    tokens_used: params.tokensUsed,
    generation_time_ms: params.generationTimeMs
  });
}

interface UsageStats {
  totalDocs: number;
  totalTokens: number;
  avgGenerationTime: number;
  docsByType: Record<string, number>;
  dailyUsage: Array<{ date: string; count: number }>;
  recentDocs: UsageLog[];
}

export async function getUserUsageStats(
  userId: string,
  teamId: string | null,
  days: number = 30
): Promise<UsageStats> {
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);

  // Build query condition
  let query = supabaseAdmin
    .from('usage_logs')
    .select('*')
    .gte('created_at', startDate.toISOString());

  if (teamId) {
    query = query.eq('team_id', teamId);
  } else {
    query = query.eq('user_id', userId);
  }

  const { data: logs, error } = await query.order('created_at', { ascending: false });

  if (error) throw error;

  const logList = logs || [];

  // Calculate stats
  const totalDocs = logList.length;
  const totalTokens = logList.reduce((sum, l) => sum + (l.tokens_used || 0), 0);
  const avgGenerationTime = totalDocs > 0
    ? Math.round(logList.reduce((sum, l) => sum + (l.generation_time_ms || 0), 0) / totalDocs)
    : 0;

  // Group by doc type
  const docsByType: Record<string, number> = {};
  logList.forEach(l => {
    docsByType[l.doc_type] = (docsByType[l.doc_type] || 0) + 1;
  });

  // Group by day
  const dailyMap: Record<string, number> = {};
  logList.forEach(l => {
    const date = new Date(l.created_at).toISOString().split('T')[0];
    dailyMap[date] = (dailyMap[date] || 0) + 1;
  });

  // Fill in missing days
  const dailyUsage: Array<{ date: string; count: number }> = [];
  for (let i = days - 1; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    dailyUsage.push({ date: dateStr, count: dailyMap[dateStr] || 0 });
  }

  return {
    totalDocs,
    totalTokens,
    avgGenerationTime,
    docsByType,
    dailyUsage,
    recentDocs: logList.slice(0, 10)
  };
}

export async function getTeamUsageStats(teamId: string): Promise<{
  stats: UsageStats;
  memberUsage: Array<{ userId: string; username: string; count: number }>;
  quotaUsed: number;
  quotaLimit: number;
}> {
  const stats = await getUserUsageStats('', teamId, 30);

  // Get per-member breakdown
  const { data: memberData } = await supabaseAdmin
    .from('usage_logs')
    .select(`
      user_id,
      profiles:user_id (github_username)
    `)
    .eq('team_id', teamId)
    .gte('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

  const memberMap: Record<string, { count: number; username: string }> = {};
  (memberData || []).forEach(m => {
    const id = m.user_id;
    if (!memberMap[id]) {
      memberMap[id] = { count: 0, username: m.profiles?.github_username || 'Unknown' };
    }
    memberMap[id].count++;
  });

  const memberUsage = Object.entries(memberMap).map(([userId, data]) => ({
    userId,
    username: data.username,
    count: data.count
  })).sort((a, b) => b.count - a.count);

  // Get quota info
  const { data: team } = await supabaseAdmin
    .from('teams')
    .select('repos_used_this_month, max_repos_per_month')
    .eq('id', teamId)
    .single();

  return {
    stats,
    memberUsage,
    quotaUsed: team?.repos_used_this_month || 0,
    quotaLimit: team?.max_repos_per_month || 100
  };
}
```

### 3. Create Analytics API Endpoint

**File:** `src/routes/api/analytics/usage/+server.ts`

```typescript
import { json, error } from '@sveltejs/kit';
import type { RequestHandler } from './$types';
import { getUserUsageStats, getTeamUsageStats } from '$lib/server/usage';

export const GET: RequestHandler = async ({ locals, url }) => {
  if (!locals.user) {
    throw error(401, 'Unauthorized');
  }

  const tier = locals.profile?.subscription_tier;
  if (!tier || !['pro', 'team'].includes(tier)) {
    throw error(403, 'Pro or Team subscription required');
  }

  const days = parseInt(url.searchParams.get('days') || '30');
  const teamId = url.searchParams.get('teamId') || locals.profile?.default_team_id;

  try {
    if (tier === 'team' && teamId) {
      const data = await getTeamUsageStats(teamId);
      return json(data);
    } else {
      const stats = await getUserUsageStats(locals.user.id, null, days);
      return json({
        stats,
        quotaUsed: locals.profile?.repos_used_this_month || 0,
        quotaLimit: 30 // Pro tier limit
      });
    }
  } catch (err) {
    console.error('Error fetching usage stats:', err);
    throw error(500, 'Failed to fetch usage statistics');
  }
};
```

### 4. Create Usage Analytics Component

**File:** `src/lib/components/UsageAnalytics.svelte`

```svelte
<script lang="ts">
  import { onMount } from 'svelte';

  export let teamId: string | null = null;

  interface Stats {
    totalDocs: number;
    totalTokens: number;
    avgGenerationTime: number;
    docsByType: Record<string, number>;
    dailyUsage: Array<{ date: string; count: number }>;
  }

  let stats: Stats | null = null;
  let quotaUsed = 0;
  let quotaLimit = 30;
  let memberUsage: Array<{ userId: string; username: string; count: number }> = [];
  let loading = true;
  let error = '';

  const docTypeColors: Record<string, string> = {
    readme: '#10b981',
    api: '#3b82f6',
    architecture: '#8b5cf6',
    setup: '#f59e0b'
  };

  const docTypeLabels: Record<string, string> = {
    readme: 'README',
    api: 'API Docs',
    architecture: 'Architecture',
    setup: 'Setup Guide'
  };

  onMount(async () => {
    try {
      const url = teamId ? `/api/analytics/usage?teamId=${teamId}` : '/api/analytics/usage';
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to load');

      const data = await res.json();
      stats = data.stats;
      quotaUsed = data.quotaUsed;
      quotaLimit = data.quotaLimit;
      memberUsage = data.memberUsage || [];
    } catch (err) {
      error = 'Unable to load usage data';
    } finally {
      loading = false;
    }
  });

  function getMaxDailyCount(): number {
    if (!stats) return 10;
    return Math.max(...stats.dailyUsage.map(d => d.count), 10);
  }

  function formatDate(dateStr: string): string {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  function formatMs(ms: number): string {
    if (ms < 1000) return `${ms}ms`;
    return `${(ms / 1000).toFixed(1)}s`;
  }

  $: quotaPercent = quotaLimit > 0 ? (quotaUsed / quotaLimit) * 100 : 0;
  $: isNearLimit = quotaPercent >= 80;
</script>

<div class="space-y-6">
  {#if loading}
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      {#each Array(4) as _}
        <div class="card p-4">
          <div class="skeleton h-4 w-20 mb-2"></div>
          <div class="skeleton h-8 w-16"></div>
        </div>
      {/each}
    </div>
  {:else if error}
    <div class="card p-6 text-center text-error">{error}</div>
  {:else if stats}
    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="card p-4">
        <p class="text-text-muted text-sm">Total Docs Generated</p>
        <p class="text-2xl font-bold text-white">{stats.totalDocs}</p>
      </div>
      <div class="card p-4">
        <p class="text-text-muted text-sm">Total Tokens Used</p>
        <p class="text-2xl font-bold text-white">{(stats.totalTokens / 1000).toFixed(1)}K</p>
      </div>
      <div class="card p-4">
        <p class="text-text-muted text-sm">Avg Generation Time</p>
        <p class="text-2xl font-bold text-white">{formatMs(stats.avgGenerationTime)}</p>
      </div>
      <div class="card p-4">
        <p class="text-text-muted text-sm">Quota Used</p>
        <p class="text-2xl font-bold {isNearLimit ? 'text-warning' : 'text-white'}">
          {quotaUsed}/{quotaLimit}
        </p>
      </div>
    </div>

    <!-- Quota Progress -->
    <div class="card p-4">
      <div class="flex justify-between items-center mb-2">
        <span class="text-text-secondary">Monthly Quota</span>
        <span class="text-sm {isNearLimit ? 'text-warning' : 'text-text-muted'}">
          {quotaPercent.toFixed(0)}% used
        </span>
      </div>
      <div class="h-3 bg-dark-600 rounded-full overflow-hidden">
        <div
          class="h-full transition-all duration-500 {isNearLimit ? 'bg-warning' : 'bg-accent'}"
          style="width: {Math.min(quotaPercent, 100)}%"
        ></div>
      </div>
    </div>

    <!-- Daily Usage Chart -->
    <div class="card p-4">
      <h3 class="text-lg font-semibold text-white mb-4">Daily Usage (Last 30 Days)</h3>
      <div class="h-40 flex items-end gap-1">
        {#each stats.dailyUsage as day, i}
          {@const height = getMaxDailyCount() > 0 ? (day.count / getMaxDailyCount()) * 100 : 0}
          <div class="flex-1 flex flex-col items-center group relative">
            <div
              class="w-full bg-accent/80 rounded-t transition-all hover:bg-accent"
              style="height: {Math.max(height, 2)}%"
            ></div>
            <!-- Tooltip -->
            <div class="absolute bottom-full mb-2 hidden group-hover:block z-10">
              <div class="bg-dark-600 text-white text-xs px-2 py-1 rounded whitespace-nowrap">
                {formatDate(day.date)}: {day.count} docs
              </div>
            </div>
          </div>
        {/each}
      </div>
      <div class="flex justify-between mt-2 text-xs text-text-muted">
        <span>{formatDate(stats.dailyUsage[0]?.date || '')}</span>
        <span>{formatDate(stats.dailyUsage[stats.dailyUsage.length - 1]?.date || '')}</span>
      </div>
    </div>

    <!-- Doc Types Breakdown -->
    <div class="card p-4">
      <h3 class="text-lg font-semibold text-white mb-4">By Document Type</h3>
      <div class="space-y-3">
        {#each Object.entries(stats.docsByType) as [type, count]}
          {@const percent = stats.totalDocs > 0 ? (count / stats.totalDocs) * 100 : 0}
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-text-secondary">{docTypeLabels[type] || type}</span>
              <span class="text-text-muted">{count} ({percent.toFixed(0)}%)</span>
            </div>
            <div class="h-2 bg-dark-600 rounded-full overflow-hidden">
              <div
                class="h-full rounded-full transition-all duration-500"
                style="width: {percent}%; background-color: {docTypeColors[type] || '#6b7280'}"
              ></div>
            </div>
          </div>
        {/each}
      </div>
    </div>

    <!-- Team Member Usage (if team) -->
    {#if memberUsage.length > 0}
      <div class="card p-4">
        <h3 class="text-lg font-semibold text-white mb-4">Team Member Activity</h3>
        <div class="space-y-2">
          {#each memberUsage as member}
            {@const percent = stats.totalDocs > 0 ? (member.count / stats.totalDocs) * 100 : 0}
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 bg-dark-600 rounded-full flex items-center justify-center">
                <span class="text-text-secondary text-sm font-medium">
                  {member.username[0]?.toUpperCase() || '?'}
                </span>
              </div>
              <div class="flex-1">
                <div class="flex justify-between text-sm">
                  <span class="text-text-primary">{member.username}</span>
                  <span class="text-text-muted">{member.count} docs</span>
                </div>
                <div class="h-1.5 bg-dark-600 rounded-full mt-1 overflow-hidden">
                  <div
                    class="h-full bg-accent rounded-full"
                    style="width: {percent}%"
                  ></div>
                </div>
              </div>
            </div>
          {/each}
        </div>
      </div>
    {/if}
  {/if}
</div>
```

### 5. Add Analytics to Dashboard

**File:** `src/routes/dashboard/+page.svelte` (additions)

Add analytics section for Pro/Team users:

```svelte
<!-- Add in script -->
export let data;
$: showAnalytics = data.profile?.subscription_tier === 'pro' || data.profile?.subscription_tier === 'team';

<!-- Add in template, after repos list -->
{#if showAnalytics}
  <section class="mt-12">
    <h2 class="text-xl font-bold text-white mb-6">Usage Analytics</h2>
    <UsageAnalytics teamId={data.profile?.default_team_id} />
  </section>
{/if}
```

### 6. Create Analytics Page (Full View)

**File:** `src/routes/dashboard/analytics/+page.svelte`

```svelte
<script lang="ts">
  import UsageAnalytics from '$lib/components/UsageAnalytics.svelte';
  import Header from '$lib/components/Header.svelte';

  export let data;
</script>

<svelte:head>
  <title>Usage Analytics - Codec8</title>
</svelte:head>

<Header />

<main class="min-h-screen bg-dark-900 pt-20">
  <div class="container mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-bold text-white">Usage Analytics</h1>
        <p class="text-text-secondary mt-1">Track your documentation generation activity</p>
      </div>
      <a href="/dashboard" class="btn-secondary">
        Back to Dashboard
      </a>
    </div>

    <UsageAnalytics teamId={data.profile?.default_team_id} />
  </div>
</main>
```

**File:** `src/routes/dashboard/analytics/+page.server.ts`

```typescript
import { redirect } from '@sveltejs/kit';
import type { PageServerLoad } from './$types';

export const load: PageServerLoad = async ({ locals }) => {
  if (!locals.user) {
    throw redirect(303, '/auth/login');
  }

  const tier = locals.profile?.subscription_tier;
  if (!tier || !['pro', 'team'].includes(tier)) {
    throw redirect(303, '/dashboard?upgrade=analytics');
  }

  return {
    profile: locals.profile
  };
};
```

## Verification

- [ ] Usage is logged on every doc generation
- [ ] Stats API returns correct aggregations
- [ ] Daily chart shows all 30 days
- [ ] Doc type breakdown is accurate
- [ ] Team member usage shows correct attribution
- [ ] Quota progress reflects actual usage
- [ ] Non-Pro/Team users cannot access analytics
- [ ] Loading and error states work correctly

## Testing Scenarios

1. Generate docs → verify usage logged
2. View analytics → verify stats match
3. Check daily chart → verify all days present
4. Check doc types → verify percentages sum to 100%
5. Team view → verify member breakdown
6. Near quota limit → verify warning appears
7. Free user tries access → verify redirect

## Notes

- Charts use pure CSS for simplicity (no external library)
- Consider adding CSV export for detailed reports
- Rate limit analytics API to prevent abuse
- Consider caching stats for performance
