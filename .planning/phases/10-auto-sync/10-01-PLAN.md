---
phase: 10-auto-sync
plan: 01
type: execute
---

<objective>
Set up GitHub webhook infrastructure for auto-sync feature.

Purpose: Enable repositories to automatically regenerate documentation when code is pushed.
Output: Database schema for webhook secrets, webhook registration endpoint, GitHub integration.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/INTEGRATIONS.md
@src/lib/server/github.ts
@src/lib/server/supabase.ts
@src/routes/api/stripe/webhook/+server.ts (pattern reference for webhook handling)

**Tech stack available:** SvelteKit 2.0, Supabase PostgreSQL, GitHub API
**Established patterns:** Server endpoints in +server.ts, service modules in lib/server/

**Constraining decisions:**
- Use existing GitHub token from profiles table for API calls
- Follow Stripe webhook pattern for signature verification
- Store webhook secrets encrypted in database
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create webhook database migration</name>
  <files>supabase/migrations/20260115_add_webhook_support.sql</files>
  <action>
    Create migration to add webhook support to repositories table:
    - Add `webhook_id` column (TEXT, nullable) - GitHub webhook ID
    - Add `webhook_secret` column (TEXT, nullable) - Secret for signature verification
    - Add `auto_sync_enabled` column (BOOLEAN, default false)
    - Add `last_synced_at` column (TIMESTAMPTZ, nullable)

    Also create index on webhook_id for fast lookups when processing webhooks.

    DO NOT add RLS policies that would block service role access.
  </action>
  <verify>Migration file exists with correct SQL syntax</verify>
  <done>Migration file created with webhook columns</done>
</task>

<task type="auto">
  <name>Task 2: Add webhook functions to GitHub service</name>
  <files>src/lib/server/github.ts</files>
  <action>
    Add two functions to the existing github.ts module:

    1. `createRepoWebhook(token: string, owner: string, repo: string, webhookUrl: string, secret: string): Promise<{ id: number }>`
       - POST to `/repos/{owner}/{repo}/hooks`
       - Config: url, content_type: 'json', secret
       - Events: ['push']
       - Active: true
       - Return webhook ID

    2. `deleteRepoWebhook(token: string, owner: string, repo: string, hookId: string): Promise<void>`
       - DELETE to `/repos/{owner}/{repo}/hooks/{hookId}`
       - Used when disabling auto-sync

    Use existing githubFetch helper. Handle errors gracefully (user may not have admin access to repo).
  </action>
  <verify>TypeScript compiles without errors: `npm run check`</verify>
  <done>Two webhook functions added to github.ts</done>
</task>

<task type="auto">
  <name>Task 3: Create webhook setup endpoint</name>
  <files>src/routes/api/repos/[id]/webhook/+server.ts</files>
  <action>
    Create endpoint to enable/disable auto-sync for a repository:

    POST: Enable auto-sync
    - Verify user session and repo ownership
    - Generate random webhook secret (32 bytes, hex)
    - Call createRepoWebhook with PUBLIC_APP_URL/api/github/webhook
    - Store webhook_id and webhook_secret in repositories table
    - Set auto_sync_enabled = true
    - Return { success: true, enabled: true }

    DELETE: Disable auto-sync
    - Verify user session and repo ownership
    - Call deleteRepoWebhook if webhook_id exists
    - Clear webhook_id, webhook_secret
    - Set auto_sync_enabled = false
    - Return { success: true, enabled: false }

    Error handling:
    - 401 if not authenticated
    - 404 if repo not found or not owned by user
    - 403 if user lacks admin access to GitHub repo (can't create webhook)
    - 500 for other errors

    Use crypto.randomBytes for secret generation.
  </action>
  <verify>
    TypeScript compiles: `npm run check`
    Endpoint responds to curl requests (without actual GitHub calls)
  </verify>
  <done>Webhook setup endpoint handles POST and DELETE with proper auth</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run check` passes without errors
- [ ] `npm run build` succeeds
- [ ] Migration file has valid SQL
- [ ] GitHub service has createRepoWebhook and deleteRepoWebhook functions
- [ ] Webhook setup endpoint handles POST and DELETE
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Database schema ready for webhook storage
- GitHub webhook creation/deletion functions ready
- Webhook setup endpoint ready for frontend integration
</success_criteria>

<output>
After completion, create `.planning/phases/10-auto-sync/10-01-SUMMARY.md`:

# Phase 10 Plan 01: Webhook Infrastructure Summary

**[Substantive one-liner]**

## Accomplishments
- Database migration for webhook support
- GitHub webhook API functions
- Webhook setup endpoint

## Files Created/Modified
- `supabase/migrations/20260115_add_webhook_support.sql`
- `src/lib/server/github.ts`
- `src/routes/api/repos/[id]/webhook/+server.ts`

## Decisions Made
[Key decisions]

## Issues Encountered
[Problems and resolutions]

## Next Step
Ready for 10-02-PLAN.md (Webhook Receiver + Auto-regeneration)
</output>
