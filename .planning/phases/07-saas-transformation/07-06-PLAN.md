---
phase: 07-saas-transformation
plan: 06
type: execute
---

<objective>
Create analytics system for tracking user actions throughout the conversion funnel.

Purpose: Enable data-driven optimization by tracking demo → signup → purchase events.
Output: Analytics utilities and event tracking integrated into key user flows.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/ARCHITECTURE.md
@src/lib/server/supabase.ts
@src/lib/stores/auth.ts

**Tech stack available:** Supabase, Svelte stores
**Established patterns:** Server utilities in src/lib/server/, stores in src/lib/stores/
**Database table required:** events (must be created via manual SQL first)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server-side analytics utility</name>
  <files>src/lib/utils/analytics.ts</files>
  <action>
Create server-side event tracking utility:

```typescript
import { supabaseAdmin } from '$lib/server/supabase';

interface EventProperties {
  [key: string]: string | number | boolean | null | undefined;
}

/**
 * Track an analytics event (server-side)
 * Silently fails to not break user flows
 */
export async function trackEvent(
  eventName: string,
  properties?: EventProperties,
  userId?: string,
  anonymousId?: string
): Promise<void> {
  try {
    await supabaseAdmin.from('events').insert({
      event_name: eventName,
      properties: properties || {},
      user_id: userId || null,
      anonymous_id: anonymousId || null,
      created_at: new Date().toISOString()
    });
  } catch (error) {
    // Log but don't throw - analytics should never break user flows
    console.error('Failed to track event:', eventName, error);
  }
}

/**
 * Track with timing information
 */
export async function trackTimedEvent(
  eventName: string,
  startTime: number,
  properties?: EventProperties,
  userId?: string,
  anonymousId?: string
): Promise<void> {
  const durationMs = Date.now() - startTime;
  await trackEvent(
    eventName,
    { ...properties, duration_ms: durationMs },
    userId,
    anonymousId
  );
}

// Event name constants for consistency
export const EVENTS = {
  // Demo flow
  DEMO_STARTED: 'demo_started',
  DEMO_COMPLETED: 'demo_completed',
  DEMO_FAILED: 'demo_failed',
  DEMO_LIMIT_REACHED: 'demo_limit_reached',

  // Auth flow
  SIGNUP_STARTED: 'signup_started',
  SIGNUP_COMPLETED: 'signup_completed',
  LOGIN_COMPLETED: 'login_completed',

  // Conversion flow
  CHECKOUT_STARTED: 'checkout_started',
  PURCHASE_COMPLETED: 'purchase_completed',
  TRIAL_STARTED: 'trial_started',
  SUBSCRIPTION_CREATED: 'subscription_created',
  SUBSCRIPTION_CANCELED: 'subscription_canceled',
  REGENERATE_PURCHASED: 'regenerate_purchased',

  // Product usage
  REPO_CONNECTED: 'repo_connected',
  DOC_GENERATED: 'doc_generated',
  DOC_EXPORTED: 'doc_exported',
  USAGE_LIMIT_HIT: 'usage_limit_hit'
} as const;
```
  </action>
  <verify>TypeScript compiles: `npm run check`</verify>
  <done>analytics.ts exports trackEvent, trackTimedEvent, and EVENTS constants</done>
</task>

<task type="auto">
  <name>Task 2: Create client-side anonymous ID store</name>
  <files>src/lib/stores/analytics.ts</files>
  <action>
Create client-side store for anonymous tracking:

```typescript
import { browser } from '$app/environment';
import { writable } from 'svelte/store';

const STORAGE_KEY = 'codec8_anonymous_id';

function generateAnonymousId(): string {
  // Generate UUID v4
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
    const r = (Math.random() * 16) | 0;
    const v = c === 'x' ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

function createAnonymousIdStore() {
  let initialId = '';

  if (browser) {
    // Try to get existing ID from localStorage
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      initialId = stored;
    } else {
      // Generate and store new ID
      initialId = generateAnonymousId();
      localStorage.setItem(STORAGE_KEY, initialId);
    }
  }

  const { subscribe } = writable<string>(initialId);

  return {
    subscribe,
    get: (): string => {
      if (browser) {
        return localStorage.getItem(STORAGE_KEY) || '';
      }
      return '';
    }
  };
}

export const anonymousId = createAnonymousIdStore();

/**
 * Get anonymous ID for tracking (safe to call on server)
 */
export function getAnonymousId(): string {
  if (browser) {
    return localStorage.getItem(STORAGE_KEY) || '';
  }
  return '';
}
```
  </action>
  <verify>TypeScript compiles: `npm run check`</verify>
  <done>analytics.ts store exports anonymousId store and getAnonymousId function</done>
</task>

<task type="auto">
  <name>Task 3: Add event tracking to key flows</name>
  <files>src/routes/api/try/+server.ts, src/routes/auth/callback/+server.ts, src/routes/api/stripe/webhook/+server.ts, src/routes/api/docs/generate/+server.ts</files>
  <action>
Add event tracking to existing endpoints:

**In /api/try/+server.ts:**
```typescript
import { trackEvent, trackTimedEvent, EVENTS } from '$lib/utils/analytics';

// At start of handler:
const startTime = Date.now();
const anonymousId = request.headers.get('x-anonymous-id') || '';

// After successful generation:
await trackTimedEvent(EVENTS.DEMO_COMPLETED, startTime, {
  repo_url: githubUrl,
  repo_owner: owner,
  repo_name: repo
}, undefined, anonymousId);

// On rate limit:
await trackEvent(EVENTS.DEMO_LIMIT_REACHED, { repo_url: githubUrl }, undefined, anonymousId);

// On failure:
await trackEvent(EVENTS.DEMO_FAILED, { error_type: 'github_error' }, undefined, anonymousId);
```

**In /auth/callback/+server.ts:**
```typescript
import { trackEvent, EVENTS } from '$lib/utils/analytics';

// After successful auth:
const isNewUser = /* check if user was just created */;
await trackEvent(
  isNewUser ? EVENTS.SIGNUP_COMPLETED : EVENTS.LOGIN_COMPLETED,
  { provider: 'github' },
  userId
);
```

**In /api/stripe/webhook/+server.ts:**
```typescript
import { trackEvent, EVENTS } from '$lib/utils/analytics';

// In checkout.session.completed handler:
if (product === 'single') {
  await trackEvent(EVENTS.PURCHASE_COMPLETED, {
    product: 'single',
    amount: 39,
    repo_url: repoUrl
  }, userId);
}

if (product === 'pro' || product === 'team') {
  await trackEvent(EVENTS.TRIAL_STARTED, { tier: product }, userId);
}

// In subscription.updated for active status:
await trackEvent(EVENTS.SUBSCRIPTION_CREATED, { tier: product }, userId);

// In subscription.deleted:
await trackEvent(EVENTS.SUBSCRIPTION_CANCELED, { tier: product }, userId);
```

**In /api/docs/generate/+server.ts:**
```typescript
import { trackEvent, EVENTS } from '$lib/utils/analytics';

// After successful generation:
await trackEvent(EVENTS.DOC_GENERATED, {
  repo_url: repoUrl,
  doc_types: types.join(','),
  tier: userTier
}, userId);

// On usage limit hit:
await trackEvent(EVENTS.USAGE_LIMIT_HIT, { tier: userTier, limit: limit }, userId);
```
  </action>
  <verify>All modified files compile: `npm run check`</verify>
  <done>Event tracking added to demo, auth, payment, and doc generation flows</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run check` passes
- [ ] `npm run build` succeeds
- [ ] analytics.ts utility created
- [ ] analytics.ts store created
- [ ] Event tracking added to 4 endpoints
</verification>

<success_criteria>
- Server-side trackEvent utility works
- Client-side anonymous ID persists in localStorage
- Demo flow tracks started/completed/failed/limit events
- Auth flow tracks signup/login events
- Payment flow tracks checkout/purchase/subscription events
- Doc generation tracks usage events
- All tracking is non-blocking (errors logged, not thrown)
</success_criteria>

<output>
After completion, create `.planning/phases/07-saas-transformation/07-06-SUMMARY.md`
</output>
