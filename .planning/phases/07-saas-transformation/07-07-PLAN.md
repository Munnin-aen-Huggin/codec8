---
phase: 07-saas-transformation
plan: 07
type: execute
---

<objective>
Update dashboard to display usage limits and purchased repositories for the new pricing model.

Purpose: Give users visibility into their subscription usage and purchased repos.
Output: Dashboard showing usage stats, purchased repos list, and upgrade prompts.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONVENTIONS.md
@src/routes/dashboard/+page.svelte
@src/routes/dashboard/+page.server.ts
@src/lib/server/usage.ts

**Tech stack available:** Svelte 5, Tailwind CSS, Supabase
**Established patterns:** Page loaders, Svelte components, toast notifications
**Dependencies:** Plan 07-02 (usage.ts), Plan 07-04 (Stripe hybrid pricing)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dashboard page loader for usage data</name>
  <files>src/routes/dashboard/+page.server.ts</files>
  <action>
Update page loader to fetch usage and purchased repos data:

```typescript
import type { PageServerLoad } from './$types';
import { redirect } from '@sveltejs/kit';
import { supabaseAdmin } from '$lib/server/supabase';

export const load: PageServerLoad = async ({ cookies }) => {
  const sessionCookie = cookies.get('session');
  if (!sessionCookie) {
    throw redirect(302, '/auth/login');
  }

  const session = JSON.parse(sessionCookie);
  const userId = session.userId;

  // Fetch profile with subscription info
  const { data: profile } = await supabaseAdmin
    .from('profiles')
    .select(`
      id,
      email,
      github_username,
      plan,
      subscription_status,
      subscription_tier,
      repos_used_this_month,
      repos_reset_at,
      trial_ends_at
    `)
    .eq('id', userId)
    .single();

  if (!profile) {
    throw redirect(302, '/auth/login');
  }

  // Fetch connected repositories
  const { data: repositories } = await supabaseAdmin
    .from('repositories')
    .select('*')
    .eq('user_id', userId)
    .order('created_at', { ascending: false });

  // Fetch purchased repos (for single-repo customers)
  const { data: purchasedRepos } = await supabaseAdmin
    .from('purchased_repos')
    .select('*')
    .eq('user_id', userId)
    .order('purchased_at', { ascending: false });

  // Calculate usage info
  let usageInfo = null;
  if (profile.subscription_tier === 'pro') {
    usageInfo = {
      used: profile.repos_used_this_month || 0,
      limit: 30,
      tier: 'Pro',
      resetDate: profile.repos_reset_at
    };
  } else if (profile.subscription_tier === 'team') {
    usageInfo = {
      used: profile.repos_used_this_month || 0,
      limit: 100,
      tier: 'Team',
      resetDate: profile.repos_reset_at
    };
  }

  // Check if in trial
  const isTrialing = profile.subscription_status === 'trialing';
  const trialEndsAt = profile.trial_ends_at;

  return {
    profile,
    repositories: repositories || [],
    purchasedRepos: purchasedRepos || [],
    usageInfo,
    isTrialing,
    trialEndsAt
  };
};
```
  </action>
  <verify>TypeScript compiles: `npm run check`</verify>
  <done>Dashboard loader returns usage info and purchased repos</done>
</task>

<task type="auto">
  <name>Task 2: Update dashboard UI with usage display</name>
  <files>src/routes/dashboard/+page.svelte</files>
  <action>
Update dashboard to display usage information and purchased repos:

```svelte
<script lang="ts">
  import type { PageData } from './$types';
  import RepoCard from '$lib/components/RepoCard.svelte';
  import { toastStore } from '$lib/stores/toast';

  export let data: PageData;

  $: ({ profile, repositories, purchasedRepos, usageInfo, isTrialing, trialEndsAt } = data);

  // Format trial end date
  $: trialEndFormatted = trialEndsAt
    ? new Date(trialEndsAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
    : null;

  // Calculate usage percentage
  $: usagePercent = usageInfo ? Math.round((usageInfo.used / usageInfo.limit) * 100) : 0;

  async function handleRegenerate(repoId: string) {
    // Redirect to regenerate checkout
    const response = await fetch('/api/stripe/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ type: 'regenerate', repoId })
    });
    const { url } = await response.json();
    if (url) window.location.href = url;
  }
</script>

<div class="max-w-6xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-white mb-8">Dashboard</h1>

  <!-- Subscription Status Banner -->
  {#if isTrialing}
    <div class="bg-emerald-900/30 border border-emerald-500/50 rounded-lg p-4 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <span class="text-emerald-400 font-medium">Free Trial</span>
          <span class="text-zinc-400 ml-2">Ends {trialEndFormatted}</span>
        </div>
        <a href="/pricing" class="text-emerald-400 hover:text-emerald-300 text-sm">
          Upgrade now →
        </a>
      </div>
    </div>
  {/if}

  <!-- Usage Stats (for subscribers) -->
  {#if usageInfo}
    <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-6 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-white">{usageInfo.tier} Plan Usage</h2>
        <span class="text-zinc-400 text-sm">
          {usageInfo.used} / {usageInfo.limit} repos this month
        </span>
      </div>
      <div class="w-full bg-zinc-800 rounded-full h-2">
        <div
          class="h-2 rounded-full transition-all {usagePercent > 80 ? 'bg-amber-500' : 'bg-emerald-500'}"
          style="width: {usagePercent}%"
        ></div>
      </div>
      {#if usagePercent > 80}
        <p class="text-amber-400 text-sm mt-2">
          Approaching limit. <a href="/pricing" class="underline">Upgrade for more</a>
        </p>
      {/if}
    </div>
  {/if}

  <!-- Purchased Repos Section (for single-repo customers) -->
  {#if purchasedRepos.length > 0}
    <div class="mb-8">
      <h2 class="text-xl font-semibold text-white mb-4">Purchased Repositories</h2>
      <div class="grid gap-4">
        {#each purchasedRepos as repo}
          <div class="bg-zinc-900 border border-zinc-800 rounded-lg p-4 flex items-center justify-between">
            <div>
              <h3 class="text-white font-medium">{repo.repo_name}</h3>
              <p class="text-zinc-500 text-sm">
                Purchased {new Date(repo.purchased_at).toLocaleDateString()}
              </p>
            </div>
            <div class="flex gap-3">
              <a
                href="/dashboard/{repo.id}"
                class="px-4 py-2 bg-zinc-800 text-white rounded hover:bg-zinc-700"
              >
                View Docs
              </a>
              <button
                on:click={() => handleRegenerate(repo.id)}
                class="px-4 py-2 border border-zinc-700 text-zinc-300 rounded hover:border-zinc-600"
              >
                Regenerate ($9)
              </button>
            </div>
          </div>
        {/each}
      </div>
    </div>
  {/if}

  <!-- Connected Repos Section -->
  <div>
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-white">Connected Repositories</h2>
      <a
        href="/dashboard/connect"
        class="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-500"
      >
        Connect Repo
      </a>
    </div>

    {#if repositories.length === 0}
      <div class="text-center py-12 bg-zinc-900 border border-zinc-800 rounded-lg">
        <p class="text-zinc-400 mb-4">No repositories connected yet</p>
        <a href="/dashboard/connect" class="text-emerald-400 hover:text-emerald-300">
          Connect your first repository →
        </a>
      </div>
    {:else}
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        {#each repositories as repo}
          <RepoCard {repo} />
        {/each}
      </div>
    {/if}
  </div>

  <!-- Upgrade CTA (for free users) -->
  {#if !usageInfo && purchasedRepos.length === 0}
    <div class="mt-8 bg-gradient-to-r from-emerald-900/30 to-zinc-900 border border-emerald-500/30 rounded-lg p-6 text-center">
      <h3 class="text-xl font-semibold text-white mb-2">Unlock All Features</h3>
      <p class="text-zinc-400 mb-4">
        Get all 4 documentation types, private repos, and unlimited generations.
      </p>
      <a
        href="/pricing"
        class="inline-block px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-500"
      >
        View Plans →
      </a>
    </div>
  {/if}
</div>
```
  </action>
  <verify>Page loads at http://localhost:5173/dashboard without errors</verify>
  <done>Dashboard displays usage stats, purchased repos, and appropriate CTAs</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Dashboard with usage display, purchased repos, and upgrade prompts</what-built>
  <how-to-verify>
    1. Run: `npm run dev`
    2. Log in (or mock session data)
    3. Visit: http://localhost:5173/dashboard
    4. Verify for subscriber:
       - Usage bar shows X of Y repos
       - Percentage fills correctly
       - Warning appears at >80%
    5. Verify for single-repo customer:
       - Purchased repos section appears
       - "View Docs" and "Regenerate ($9)" buttons visible
    6. Verify for free user:
       - Upgrade CTA banner appears
       - No usage stats shown
    7. Verify trial banner:
       - Shows trial end date
       - "Upgrade now" link works
    8. Mobile: Check responsive layout
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run check` passes
- [ ] `npm run build` succeeds
- [ ] Dashboard loads with usage data
- [ ] All user states handled (subscriber, single-repo, free, trial)
- [ ] Human verification approved
</verification>

<success_criteria>
- Dashboard loader fetches all required data
- Usage bar displays correctly for subscribers
- Purchased repos section works for single-repo customers
- Upgrade CTAs appear for free users
- Trial banner shows for trialing users
- Regenerate button initiates checkout
- Mobile responsive
- Phase 7 complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-saas-transformation/07-07-SUMMARY.md`

Final summary should note:
- Phase 7: SaaS Transformation complete
- All 7 plans executed
- Ready for manual testing and deployment
</output>
