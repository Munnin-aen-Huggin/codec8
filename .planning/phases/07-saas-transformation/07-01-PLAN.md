---
phase: 07-saas-transformation
plan: 01
type: execute
---

<objective>
Create server-side utilities for rate limiting and bot detection to protect the demo endpoint.

Purpose: Establish security infrastructure before building the public demo endpoint.
Output: Two utility modules that handle IP hashing, rate limit checking, and bot detection.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
@src/lib/server/supabase.ts

**Tech stack available:** SvelteKit 2.49.1, TypeScript 5.9.3, Supabase
**Established patterns:** Service modules in src/lib/server/, camelCase functions, async/await
**Database tables required:** demo_usage, blocked_clients (must be created via manual SQL first)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rate limiting utility module</name>
  <files>src/lib/server/ratelimit.ts</files>
  <action>
Create rate limiting utility with these exports:

```typescript
import { createHash } from 'crypto';
import { supabaseAdmin } from './supabase';

export function hashIP(ip: string): string
// SHA256 hash of IP address - never store raw IPs

export function hashFingerprint(fp: string): string
// SHA256 hash of browser fingerprint

export async function isBlocked(ipHash: string, fingerprint?: string): Promise<boolean>
// Query blocked_clients table, check if IP or fingerprint is blocked
// Consider expires_at (null = permanent, otherwise check date)

export async function checkDemoLimit(ipHash: string): Promise<{ allowed: boolean; remaining: number }>
// Query demo_usage for ipHash + today's date
// Limit is 1 per day per IP
// Return { allowed: used < 1, remaining: Math.max(0, 1 - used) }

export async function incrementDemoUsage(
  ipHash: string,
  metadata: { repoUrl: string; userAgent: string; fingerprint?: string; isSuspicious?: boolean }
): Promise<void>
// Upsert into demo_usage with today's date
// Use onConflict: 'ip_hash,date' for upsert

export async function blockClient(
  ipHash: string,
  reason: string,
  durationHours?: number
): Promise<void>
// Insert into blocked_clients
// If durationHours provided, set expires_at, otherwise null (permanent)
```

Use existing supabaseAdmin client from supabase.ts. Follow project conventions (tabs, single quotes, no trailing commas).
  </action>
  <verify>TypeScript compiles without errors: `npm run check`</verify>
  <done>ratelimit.ts exports all 5 functions with proper types</done>
</task>

<task type="auto">
  <name>Task 2: Create bot detection utility module</name>
  <files>src/lib/server/botdetect.ts</files>
  <action>
Create bot detection utility with these exports:

```typescript
const BOT_PATTERNS = [
  /curl/i,
  /wget/i,
  /python-requests/i,
  /python-urllib/i,
  /scrapy/i,
  /httpclient/i,
  /java\//i,
  /libwww/i,
  /lwp-/i,
  /perl/i,
  /ruby/i,
  /mechanize/i,
  /phantom/i,
  /headless/i,
  /puppeteer/i,
  /playwright/i,
  /selenium/i
];

export function isSuspiciousUA(userAgent: string | null): boolean
// Return true if:
// - userAgent is null, undefined, or empty string
// - userAgent matches any BOT_PATTERNS
// Return false otherwise (legitimate browser UA)

export function getClientIP(request: Request): string
// Extract IP from headers in order:
// 1. x-forwarded-for (first IP if comma-separated)
// 2. x-real-ip
// 3. cf-connecting-ip (Cloudflare)
// 4. Fallback to '0.0.0.0' if none found
```

Keep it simple - no external dependencies. Follow project conventions.
  </action>
  <verify>TypeScript compiles without errors: `npm run check`</verify>
  <done>botdetect.ts exports isSuspiciousUA and getClientIP functions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run check` passes without errors
- [ ] `npm run build` succeeds
- [ ] Both files exist in src/lib/server/
- [ ] No lint errors: `npm run lint`
</verification>

<success_criteria>
- ratelimit.ts created with 5 exported functions
- botdetect.ts created with 2 exported functions
- All TypeScript types are explicit
- Code follows project conventions (tabs, single quotes)
- No compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-saas-transformation/07-01-SUMMARY.md`
</output>
