---
phase: 07-saas-transformation
plan: 02
type: execute
---

<objective>
Create the demo API endpoint that generates README documentation without requiring authentication.

Purpose: Enable try-without-signup experience - the critical conversion event for the SaaS transformation.
Output: Functional /api/try endpoint with rate limiting, validation, and Claude-powered README generation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/INTEGRATIONS.md
@src/lib/server/ratelimit.ts
@src/lib/server/botdetect.ts
@src/lib/server/claude.ts
@src/lib/server/github.ts
@src/lib/server/supabase.ts

**Tech stack available:** SvelteKit, Claude API, GitHub API
**Established patterns:** RequestHandler exports, try/catch error handling, json() responses
**Dependencies:** Plan 07-01 must be complete (ratelimit.ts, botdetect.ts)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create demo API endpoint</name>
  <files>src/routes/api/try/+server.ts</files>
  <action>
Create POST endpoint for demo README generation:

```typescript
import { json, error } from '@sveltejs/kit';
import type { RequestHandler } from './$types';
import { hashIP, isBlocked, checkDemoLimit, incrementDemoUsage } from '$lib/server/ratelimit';
import { isSuspiciousUA, getClientIP } from '$lib/server/botdetect';
import { supabaseAdmin } from '$lib/server/supabase';
import Anthropic from '@anthropic-ai/sdk';
import { ANTHROPIC_API_KEY } from '$env/static/private';

export const POST: RequestHandler = async ({ request }) => {
  // STEP 1: Parse request body
  const { githubUrl, fingerprint } = await request.json();

  // STEP 2: Validate GitHub URL format
  // Must match: https://github.com/owner/repo or github.com/owner/repo
  // Extract owner and repo name
  // Return 400 if invalid format

  // STEP 3: Anti-abuse checks
  const clientIP = getClientIP(request);
  const ipHash = hashIP(clientIP);
  const userAgent = request.headers.get('user-agent');

  // Check User-Agent
  if (isSuspiciousUA(userAgent)) {
    return json({ error: 'invalid_request', message: 'Invalid request' }, { status: 400 });
  }

  // Check blocked list
  if (await isBlocked(ipHash, fingerprint)) {
    return json({ error: 'blocked', message: 'Access restricted' }, { status: 403 });
  }

  // STEP 4: Rate limiting (1/day per IP)
  const { allowed, remaining } = await checkDemoLimit(ipHash);
  if (!allowed) {
    return json({
      error: 'limit_reached',
      message: 'Daily demo limit reached. Start your free trial for unlimited access.',
      canTryAgainAt: getNextMidnightUTC()
    }, { status: 429 });
  }

  // STEP 5: Validate repository exists (HEAD request to GitHub API)
  // Return 400 if not found or private

  // STEP 6: Fetch repo context (limited - cost control)
  // - Root directory listing
  // - README.md if exists
  // - package.json OR requirements.txt OR Cargo.toml OR go.mod
  // - First 3 files from src/ or lib/ or app/
  // Limit total content to ~4000 tokens

  // STEP 7: Generate README with Claude
  // Use claude-sonnet-4-20250514, max_tokens: 2000, temperature: 0.3
  // Build prompt with repo context

  // STEP 8: Record usage
  await incrementDemoUsage(ipHash, {
    repoUrl: githubUrl,
    userAgent: userAgent || '',
    fingerprint,
    isSuspicious: false
  });

  // STEP 9: Return result
  return json({
    readme: generatedReadme,
    repoName: `${owner}/${repo}`,
    generationsRemaining: 0
  });
};

function getNextMidnightUTC(): string {
  const tomorrow = new Date();
  tomorrow.setUTCDate(tomorrow.getUTCDate() + 1);
  tomorrow.setUTCHours(0, 0, 0, 0);
  return tomorrow.toISOString();
}
```

Handle errors gracefully:
- GitHub API errors → 400 "Could not access repository"
- Claude API errors → 500 "Generation failed, please try again"
- Always log errors with context for debugging
  </action>
  <verify>
Test with curl:
```bash
curl -X POST http://localhost:5173/api/try \
  -H "Content-Type: application/json" \
  -d '{"githubUrl": "https://github.com/sveltejs/kit"}'
```
Should return JSON with readme field or appropriate error.
  </verify>
  <done>
- POST /api/try returns generated README for valid public repos
- Returns 400 for invalid URLs or private repos
- Returns 429 when rate limit exceeded
- Returns 403 for blocked clients
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usage tracking utility</name>
  <files>src/lib/server/usage.ts</files>
  <action>
Create usage tracking utility for subscription-based limits (used in Plan 07-04):

```typescript
import { supabaseAdmin } from './supabase';

interface UsageResult {
  allowed: boolean;
  used: number;
  limit: number;
  tier: string;
}

export async function checkUsageLimit(userId: string): Promise<UsageResult>
// Query profile for subscription_tier and repos_used_this_month
// Pro: limit 30, Team: limit 100
// Return { allowed: used < limit, used, limit, tier }

export async function canGenerateForRepo(
  userId: string,
  repoUrl: string
): Promise<{ allowed: boolean; reason?: string }>
// Check subscription status first
// If active subscriber, check usage limits
// If not subscriber, check purchased_repos table
// Return { allowed: true } or { allowed: false, reason: 'Monthly limit reached' | 'Purchase required' }

export async function incrementUsage(userId: string): Promise<void>
// Increment repos_used_this_month in profiles table
// Use raw SQL: repos_used_this_month = repos_used_this_month + 1

export async function getProfile(userId: string): Promise<Profile | null>
// Fetch profile with subscription fields
// Return null if not found
```

Types needed:
```typescript
interface Profile {
  id: string;
  email: string;
  plan: string;
  subscription_status: string | null;
  subscription_tier: string | null;
  repos_used_this_month: number;
}
```
  </action>
  <verify>TypeScript compiles without errors: `npm run check`</verify>
  <done>usage.ts exports checkUsageLimit, canGenerateForRepo, incrementUsage, getProfile</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run check` passes
- [ ] `npm run build` succeeds
- [ ] Dev server starts: `npm run dev`
- [ ] POST /api/try responds (may need database tables)
</verification>

<success_criteria>
- /api/try endpoint created and handles all request flows
- usage.ts utility created for subscription tracking
- Rate limiting integrated correctly
- Bot detection integrated correctly
- Error handling returns appropriate status codes
</success_criteria>

<output>
After completion, create `.planning/phases/07-saas-transformation/07-02-SUMMARY.md`
</output>
